######## instalando ldap ###########################
# actualizacion de los repos
sudo apt update; sudo apt install -y slapd ldap-utils	

# configurando el hostname **FQDN
sudo hostnamectl set-hostname ldap.cultura.lab
echo '192.168.121.200 ldap.cultura.lab ldap' | sudo tee -a /etc/hosts

# reconfigurando slapd
sudo dpkg-reconfigure slapd
--> omit openLDAP server configuration? NO
--> DNS domain name: cultura.lab
--> Organization name: cultura
--> remove database when slapd is purged? NO
--> move old database? YES

# chequeando la configuracion
sudo slapcat

# guardando los cambios
sudo ldapadd -D "cn=admin,dc=cultura,dc=lab" -W -H ldapi:/// -f /etc/ldap/users.ldif

# buscando OUs en el dominio cultura.lab
ldapsearch -x -b "dc=cultura,dc=lab" ou

# buscando todos los datos del OU Personal
ldapsearch -x -b "ou=Personal,dc=cultura,dc=lab"

# buscando por campo - street
ldapsearch -x -D "cn=admin,dc=ldap,dc=com" -w "eteZZisn" -h ldap-01.cs56cloud.internal -b "dc=ldap,dc=com" "(&(cn=dmoroz)(objectClass=*)(street=ovpn))"

# buscando miembros de grupos
sudo ldapsearch -H ldapi:/// -Y EXTERNAL -LLL -b "dc=cultura,dc=lab" cn=SOAP

# listando ACL
sudo ldapsearch  -Y EXTERNAL -H ldapi:/// -b cn=config 'olcDatabase={1}mdb'

# aplicando nuevos ACLs
sudo ldapmodify  -Y EXTERNAL -H ldapi:/// -f add_acl.ldif 

##################### grupos en ldap ##########
# chequeando si el modulo memberof esta cargado
ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b  cn=config -LLL | grep -i module

# buscando el modulo ## /usr/lib/ldap/memberof.la
sudo find / -iname memberof.la 2>/dev/null

# cargando modulo memberof
dn: cn=module{0},cn=config
changetype: modify
add: olcModuleLoad
olcModuleLoad: memberof.la

ldapadd -Y EXTERNAL -H ldapi:/// -f update-module.ldif

# verificando 
ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b  cn=config -LLL | grep -i module

# actualizando la DB mdb
dn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config
objectClass: olcMemberOf
objectClass: olcOverlayConfig
objectClass: olcConfig
objectClass: top
olcOverlay: memberof 
olcMemberOfRefInt: TRUE
olcMemberOfDangling: ignore
olcMemberOfGroupOC: groupOfNames
olcMemberOfMemberAD: member
olcMemberOfMemberOfAD: memberOf

ldapadd -Y EXTERNAL -H ldapi:/// -f add-memberof-overlay.ldif

# cargando modulo referential integrity
dn: cn=module{0},cn=config
changetype: modify
add: olcModuleLoad
olcModuleLoad: refint.la

ldapadd -Y EXTERNAL -H ldapi:/// -f add-refint.ldif

# creando grupos
############## GRUPO SOAP
dn: cn=SOAP,ou=SOPORTE,dc=cultura,dc=lab
objectClass: groupOfNames
cn: SOAP
member: uid=goku,ou=USUARIOS,dc=cultura,dc=lab
member: uid=krilin,ou=USUARIOS,dc=cultura,dc=lab

####### instalando phpldapadmin #################
sudo apt -y install phpldapadmin

# configurando phpldapadmin
sudo nano /etc/phpldapadmin/config.php
--> $servers->setValue('server','host','server_domain_name_or_IP');
--> $servers->setValue('server','base',array('dc=cultura,dc=lab'));
--> $servers->setValue('login','bind_id','cn=admin,dc=cultura,dc=lab');
--> $config->custom->appearance['hide_template_warning'] = true;





